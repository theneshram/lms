import { Router } from 'express';
import { requireAuth, requireRole } from '../middleware/auth.js';
import Course from '../models/Course.js';
import Enrollment from '../models/Enrollment.js';

const router = Router();

router.get('/', requireAuth, async (_req, res) => {
  const items = await Course.find().sort({ createdAt: -1 });
  res.json(items);
});

router.post('/', requireAuth, requireRole('admin','teacher'), async (req, res) => {
  const { title, code, description, image, startDate, endDate, durationWeeks } = req.body;
  const course = await Course.create({ title, code, description, image, startDate, endDate, durationWeeks, createdBy: req.user.id });
  res.status(201).json(course);
});

router.post('/:courseId/enroll', requireAuth, requireRole('admin','teacher'), async (req, res) => {
  const { userId, role } = req.body;
  const { courseId } = req.params;
  const enr = await Enrollment.create({ course: courseId, user: userId, role });
  res.status(201).json(enr);
});

router.get('/:courseId/enrollments', requireAuth, async (req, res) => {
  const list = await Enrollment.find({ course: req.params.courseId }).populate('user', 'name email role');
  res.json(list);
});

export default router;